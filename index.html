<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <title>Grimoire</title>
  </head>
  <body>
    <!--
    Things to include
        visual elements
            circular buttons
                big border
                selectable
                    on select, change border color
                can be unselectable
            submit button for targets
    TODO:
        sub radial for reminders
            calculate position based on main circle
        show all reminders tab
        make circles selectable

        add submit button
        add text header
    -->
    <style>
        body {
            display: flex;
            height: 100vh; /*need height and width for centering*/
            width: 100vw;
            justify-content: center;
            align-items: center;
            max-width: 1080px;
            max-height: 1920px;
            margin: 0 auto;
            overflow: hidden;
            background-color: #200e2f;
        }
        text {
            font-size: 1.5vmin;
            font-family: Arial, sans-serif;
            align-self: center;
        }
        .radial-container {
            /* grid layout */
            display: flex;             
            justify-content: center;
            align-items: center;
            height: 100vmin;
            width: 100vmin;
        }
        .circle {
            display: flex;
            position: absolute;
            /* without absolute positioning the circles will not overlap on spawn */
            background-color: black; /* for non selectable? */
            background-color: #d9af37; /* for selected? */
            border-radius: 50%;
            align-items: center;
            justify-content: center;
        }
        .circle text {
             font-family: 'JetBrains Mono', monospace;
            position: absolute;
            color: white;
        }
        .circle img {
            position: absolute;
        }
    </style>
    <div class="radial-container"></div>
    <script>
        class Circle {
            constructor(radial, theta, diameter, textSize = 3, name = "Player") {
                console.log(`Creating circle at radial: ${radial}, theta: ${theta}, diameter: ${diameter}, name: ${name}`);
                //TODO: place sub elements in divs so that they can be modified without changing overlap
                // create circle div
                let div = document.createElement("div");
                div.className = "circle";
                div.style.width = diameter + "vmin";
                div.style.height = diameter + "vmin";
                
                // Store properties on the div element so we can access them later
                div.radial = radial;
                div.theta = theta;
                div.diameter = diameter;

                // add background image
                let image = document.createElement("img");
                image.src = './images/textures/paper-circle.png';
                image.style.width = "85%";
                div.appendChild(image);

                // add role or block image
                // TODO: show these selectively
                // for testing, show all of them overlapping to make sure they resize properly
                image = document.createElement("img");
                // count images in the roles folder
                let hide = {
                /*
                    const roles = [
                        'baron.png',
                        'butler.png',
                        'chef.png',
                        'empath.png',
                        'fortuneteller.png',
                        'imp.png',
                        'investigator.png',
                        'librarian.png',
                        'mayor.png',
                        'monk.png',
                        'poisoner.png',
                        'ravenkeeper.png',
                        'recluse.png',
                        'saint.png',
                        'scarletwoman.png',
                        'slayer.png',
                        'soldier.png',
                        'spy.png',
                        'undertaker.png',
                        'virgin.png',
                        'washerwoman.png'
                    ]
                    // for each image in the roles folder, add it to the circle
                    //for (let i = 0; i < roles.length; i++) {
                    //    console.log(`Adding role image: ${roles[i]}`);
                    //    image = document.createElement("img");
                    //    image.src = `./images/roles/${roles[i]}`;
                    //    image.style.width = "115%";
                    //    image.style.opacity = 0.5;
                    //    div.appendChild(image);
                    //}
                */
                }
                image.src = './images/roles/imp.png';
                // 115% seems to work well
                image.style.width = "115%";
                div.appendChild(image);

                // add half transparent shadow for text visibility
                let shadow = document.createElement("div");
                shadow.style.position = "absolute";
                shadow.style.width = "100%";
                shadow.style.height = "16%";
                shadow.style.backgroundColor = "rgba(0, 0, 0, .66)";
                div.appendChild(shadow);

                // add name text
                let text = document.createElement("text");
                text.innerText = name;
                text.style.fontSize = textSize + "vmin";
                div.appendChild(text);
                console.log(`Created circle at radial: ${div.radial}, theta: ${div.theta}, diameter: ${div.diameter}`);
                return div;
            }
        }


        function checkCircleOverlapPolar(r1, theta1, R1, r2, theta2, R2) {
            console.log(`Checking overlap: Circle 1 (r=${r1}, theta=${theta1}, R=${R1}), Circle 2 (r=${r2}, theta=${theta2}, R=${R2})`);
            // Convert polar coordinates to Cartesian coordinates
            const x1 = r1 * Math.cos(theta1);
            const y1 = r1 * Math.sin(theta1);
            const x2 = r2 * Math.cos(theta2);
            const y2 = r2 * Math.sin(theta2);

            // Calculate the distance between the centers
            const dx = x2 - x1;
            const dy = y2 - y1;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // Check for overlap
            // If the distance is less than or equal to the sum of the radii, they overlap.
            const sumOfRadii = R1 + R2 + 0.15; // add a small buffer to prevent visual overlap
            return distance <= sumOfRadii;
        }

        function resizeCircles(circles) {
            let overlap = false;
            do {
                overlap = checkCircleOverlapPolar(
                    circles[0].radial,
                    circles[0].theta,
                    circles[0].diameter/2,
                    circles[1].radial,
                    circles[1].theta,
                    circles[1].diameter/2);
                console.log("overlap: " + overlap);
                if (overlap) {
                    console.log("repositioning circles");
                    // reposition circles
                    for (let i = 0; i < circles.length; i++) {
                        circles[i].style.width = (circles[i].diameter - 0.1) + "vmin";
                        circles[i].style.height = (circles[i].diameter - 0.1) + "vmin";
                        circles[i].diameter -= 0.1;
                    }
                }
            } while (overlap);
        }

        function resizeTexts(circles) {
            for (let i = 0; i < circles.length; i++) {
                let text = circles[i].getElementsByTagName("text")[0];
                let textSize = parseFloat(text.style.fontSize);
                let textLength = text.innerText.length;
                // the 0.6 is an empirically derived constant that seems to work well for fitting text within circles
                while ((textSize * textLength * 0.6) > circles[i].diameter) {
                    textSize -= 0.1;
                    text.style.fontSize = textSize + "vmin";
                }
            }
        }

        function positionCircles() {
            try {
                // load all circles
                const radius = 35;
                const players = 14;
                const maxCircleSize = 16; // in vmin
                let radial = document.getElementsByClassName("radial-container")[0];
                
                // set the angle increment
                let angleIncrement = 360 / players;

                // create circles
                for (let i = 0; i < players; i++) {
                    let angle = (angleIncrement * i) // get angle in degrees
                    angle = angle * (Math.PI / 180); // convert to radians
                    angle = (2*Math.PI)-angle; // invert angle for correct direction
                    //angle is now the radian position of the circle,
                    //  using polar coordinates, but with 0 at THE TOP
                    let name = `Player${(i+1)*10000}`; // placeholder name test
                    radial.appendChild(new Circle(radius, angle, maxCircleSize, 3, name));
                }

                // count them
                //  use count just in case we want to modify the player count later
                let circles = radial.children;
                let count = circles.length;
                // for each circle, transform by angle * index
                for (let i = 0; i < count; i++) {
                    let angle = (angleIncrement * i) - 90;
                    if (angle < 0) {
                        angle += 360;
                    }
                    circles[i].style.transform = `rotate(${angle}deg) translate(${radius}vmin) rotate(-${angle}deg)`;
                }
                resizeCircles(circles);
                resizeTexts(circles);

            } catch (e) {
                alert("error: " + e);
            }
        }
        window.onload = positionCircles;
    </script>
  </body>
</html>